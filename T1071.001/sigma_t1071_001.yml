title: Suspicious PowerShell HTTP Communication with Anomalous User-Agent
id: 9c2b4c20-1071-001-ps-http
status: experimental
description: >
  Detects PowerShell making HTTP requests using uncommon or suspicious User-Agent
  strings via command-line arguments. This behavior is commonly observed in
  Command and Control channels abusing HTTP/S (MITRE T1071.001).
author: Nicolas Gatica
date: 2025/12/06
references:
  - https://attack.mitre.org/techniques/T1071/001/
logsource:
  category: process_creation
  product: windows
detection:
  selection_image:
     Image|endswith:
      - '\powershell.exe'
      - '\pwsh.exe'
     OriginalFileName:
      - 'PowerShell.EXE'
      - 'pwsh.dll'

  selection_command:
    CommandLine|contains:
      - 'Invoke-WebRequest'
      - 'Invoke-RestMethod'
      - 'iwr'
      - 'irm'
      - 'curl' 
      - 'wget'  

  selection_user_agent:
    CommandLine|contains:
      - 'HttpBrowser'
      - 'Opera/'
      - 'Chrome/1.0'
      - '*<|>*'
      - 'Metasploit'
      - 'Nmap'
      - 'User-Agent "curl'
      - 'User-Agent "wget' 
      - 'User-Agent "Mozilla/4.0"' 

  condition: selection_image and selection_command and selection_user_agent

falsepositives:
  - Legitimate administrative scripts using PowerShell for web downloads with custom headers.
  - DevOps tools explicitly testing User-Agent filtering.

level: high

tags:
  - attack.command_and_control
  - attack.t1071.001
